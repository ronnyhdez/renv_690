---
title: "Discriminant analysis and MANOVA"
author: "Ronny A. Hernández Mora"
date: "26/01/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(janitor)
library(dplyr)
library(readr)
library(ggplot2)
library(MASS)
library(candisc)
library(biotools)# This library masks the select from dplyr!!!
library(vegan)

# Import data
## csv with iris data is the same as the one loaded in R
# iris <- read_csv("data/lab_4/iris.csv") %>% 
#   clean_names()
```

## 4.1 Discriminant analysis

First, we are going to do a linear discriminant analysis

```{r}
iris_clean <- iris %>% 
  clean_names()
  
lda_iris <- lda(species ~ ., data = iris_clean)
```

Now that we have the analysis, we can obtain the scores (the new coordinate
position of points after the matrix rotation)

```{r}
scores_lda_iris <- predict(lda_iris, iris_clean)

scores_data <- scores_lda_iris[["x"]] %>% 
  as_tibble() %>% 
  bind_cols(scores_lda_iris[["class"]]) %>% 
  rename("class" = "...3")

ggplot(scores_data, aes(x = LD1, y = LD2, color = class)) +
  geom_point() +
  scale_color_viridis_d() +
  theme_light()

# scores = predict(out1, iris)$x
# plot(scores_lda_iris[,1:2], col=rainbow(3)[as.factor(iris_clean$species)],
#      asp=1)
```

### Alternative with `candisc` package

 - For the `lm()` function, we want to explain the numeric variables as a
 function of species. To pass this formula to the function, we need to create
 first a matrix with the numeric variables or do it with a `cbind` as shown
 in the original lab code.
```{r}
numeric_variables <- iris_clean %>% 
  dplyr::select(-species) %>% 
  as.matrix()

model <- lm(numeric_variables ~ species, data = iris_clean)

## The formula before its not the same as:
# lm(sepal_length + sepal_width + petal_length + petal_width ~ species,
#    data = iris_clean)

candisc_results <- candisc(model, term = "species")

summary(candisc_results)

candisc_results[["structure"]] # This are the loadings

## Original R code lab
# x = lm(cbind(sepal_length, sepal_width, petal_length, petal_width) ~ species,
#      data = iris_clean)
# out2 = candisc(x, term = "species")
# summary(out2)
# out2$structure
# plot(out2, which = c(1, 2), scale = 8, var.col = "#777777", var.lwd = 1,
#      col = rainbow(3))
```

## 4.2 Classifying new observations

Now, we are going to use new data to classify according to our model

```{r}
new_specimens <- read_csv("data/lab_4/iris_unknown.csv") %>% 
  clean_names() %>% 
  rename(sepal_length = sep_length,
         sepal_width = sep_width,
         petal_length = pet_length,
         petal_width = pet_width)
```


```{r}
# Create the model with the known data
training <- lda(species ~ ., iris_clean)

# Classify new data with 
predict(training, new_specimens)$class

# Let's check the confussion matrix
prediction <- predict(training, iris_clean)$class
confusionmatrix(iris_clean$species, prediction)

## Original lab code
# unknown = read.csv("iris_unknown.csv")
# View(unknown)
# out1 = lda(Species~., iris)
# predict(out1, unknown)$class
# pred1 = predict(out1, iris)$class
# library(biotools)
# confusionmatrix(iris$Species, pred1)
```

We are going to add the new observation to our plot:

```{r}
scores <- predict(training, iris_clean)$x

plot(scores[ , 1:2], asp = 1, col = rainbow(3)[as.factor(iris_clean$species)])

scores_unknown <- predict(training, new_specimens)$x

points(scores_unknown[, 1:2], pch = 19)

vectors <- envfit(scores[ , 1:2], iris_clean[ , 1:4], permutations = 0)

plot(vectors, col = "black")

## Original lab code
# scores = predict(out1, iris)$x
# plot(scores[,1:2], asp=1,col=rainbow(3)[as.factor(iris$Species)])
# scores_unknown = predict(out1, unknown)$x
# points(scores_unknown[,1:2], pch=19)
# library(vegan)
# vectors = envfit(scores[,1:2], iris[,1:4], permutations=0)
# plot(vectors, col="black")
```


## 4.3 Testing for significant differences among groups

MANOVA is mathematically equal to a discriminant analysis, but
is used when we have a different question: Do we really have
different species?

```{r}
species <- iris_clean %>% 
  dplyr::select(species) %>% 
  as.matrix()

measurements <- iris_clean %>% 
  dplyr::select(-species) %>% 
  as.matrix()

manova_model <- manova(measurements ~ species)

summary(manova_model, test = "Wilks")

summary.aov(manova_model)

## Original lab code
# species = as.matrix(iris[,5])
# measurements = as.matrix(iris[,1:4])
# out3 = manova(measurements~species)
# summary(out3, test="Wilks")# MANOVA table of Wilks' lambda
# summary.aov(out3)# Univariate ANOVA tables
```

Assumptions of MANOVA are the same as ANOVA: homocedasticity and
normal variance distribution:

```{r}
boxplot(iris_clean$sepal_length ~ iris_clean$species)
plot(residuals(lm(sepal_length ~ species, data = iris_clean)))

## Original lab code
# boxplot(iris$SepLength~iris$Species)
# plot(residuals(lm(SepLength~Species, data=iris)))
```

## 4.4 Discriminant analysis – climate change projections

For this exercise, the Alberta climate dataset is going to be used given that
it has a the `ecosys` variable which is going to be our predetermined class
variable.

In this exercise we are going to make ecosystem predictions for a new set of
observations: climate change predictions for the 2020's, 2050's, and 2080's
from the Canadian atmosphere-ocean coupled general circulation model CGCM2-B2

```{r}
ab_climate <- read_csv("data/lab_4/AB_Climate.csv") %>% 
  clean_names()

# Data with ecosystems and colors assginated 
ab_ecosystems <- read_csv("data/lab_4/AB_Ecosystems.csv") %>% 
  clean_names()

plot(y~x, data = ab_climate, pch = 21, asp = 1,
     col = ab_ecosystems$ecol[as.factor(ecosys)])

# ggplot(data = ab_climate, aes(x = x, y = y, fill = ecosys)) +
#   geom_point() +
#   scale_fill_viridis_d()

## Original lab code
# ab6190=read.csv("AB_Climate.csv")
# head(ab6190)
# attach(ab6190)
# ecosys=read.csv("AB_Ecosystems.csv")
# head(ecosys)
# ecol=as.character(ecosys$ECOL)
# ename=ecosys$ENAME
# plot(Y~X, pch=21, asp=1, col=ecol[as.factor(ECOSYS)])
```

Now that we have plotted the data, we can continue to build our model:

<!-- #TODO: Why is there a prediction with the same data used to build the model? -->
```{r}
ab_lda_climate <- lda(ecosys ~ mat + mwmt + mcmt + msp + ahm, 
                      data = ab_climate)

pred_ab_lda_climate <- predict(ab_lda_climate, ab_climate)$class


plot(y~x, data = ab_climate, pch = 21, asp = 1,
     col = ab_ecosystems$ecol[pred_ab_lda_climate])

## Original lab code
# library(MASS)
# out1=lda(ECOSYS~MAT+MWMT+MCMT+MAP+MSP+AHM, ab6190)
# pred6190=predict(out1, ab6190)$class
# plot(Y~X, pch=21, asp=1, col=ecol[pred6190])
```

Now that we built our model, we can continue and make some predictions for the
year 2020

```{r}
ab_climate_2020 <- read_csv("data/lab_4/AB_Climate_2020s.csv") %>% 
  clean_names()

pred_20 <- predict(ab_lda_climate, ab_climate_2020)$class

plot(y ~ x, data = ab_climate, pch = 21, asp = 1, col = ecol[pred_20])

## Original lab code
# ab2020 = read.csv("AB_Climate_2020s.csv")
# pred2020 = predict(out1, ab2020)$class
# plot(Y~X, pch=21, asp=1, col=ecol[pred2020])
```














